<!doctype html>
<html>
<head>
  <title>Socket.IO chat</title>
  <link href="bootstrap.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font: 13px Helvetica, Arial;
    }

    form {
      background: #000;
      padding: 3px;
      position: fixed;
      bottom: 0;
      width: 100%;
    }

    form input {
      border: 0;
      padding: 10px;
      width: 70%;
      margin-right: .5%;
      float: left;
    }

    form button {
      width: 9%;
      background: rgb(130, 224, 255);
      border: none;
      padding: 10px;
      float: left;
    }

    form select {
      width: 20%;
      margin-right: .5%;
      padding: 8px;
      float: left;
    }

    #messages {
      list-style-type: none;
      margin: 0;
      padding: 0;
      width: 80%
    }

    #messages li {
      padding: 5px 10px;
    }

    #messages li:nth-child(odd) {
      background: #eee;
    }

    .online_users {
      position: fixed;
      right: 0;
      width: 20%;
      height: 100%;
      padding: 5px;
      overflow-x: hidden;
      overflow-y: auto;
      border-left: 1px solid #ccc;
    }
  </style>
</head>
<body>
<div class="online_users">

</div>
<ul id="messages"></ul>
<form action="">
  <select id="sel_user">
    <option value="">所有人</option>
  </select>
  <input id="cur_input" autocomplete="off"/>
  <button>Send</button>
</form>

<div class="modal fade" id="alert-box">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title">Modifiy user nickname</h4>
      </div>
      <div class="modal-body">
        <label for="nickname">nickname:</label>
        <input type="text" name="nickname" id="nickname"/>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="modify_uid()">Save changes</button>
      </div>
    </div>
    <!-- /.modal-content -->
  </div>
  <!-- /.modal-dialog -->
</div>
<!-- /.modal -->

<script src="/socket.io/socket.io.js"></script>
<script src="http://code.jquery.com/jquery-1.11.1.js"></script>
<script src="bootstrap.js"></script>
<script>
  var socket = io();
  var online_list;
  var cur_user;
  /*
   当群聊时，
   用户输入时，其他用户显示 xx is typing；
   用户清空输入，其他用户取消提示信息；
   当私聊时，清空其他提示信息。
   */
  $('#cur_input').bind('input propertychange', function () {
    if ($('#sel_user :selected').text() == "所有人" && $("#cur_input").val() != "") {
      socket.emit('typing', cur_user);
    } else {
      socket.emit('typing', '');
    }
  });

  $('form').submit(function () {
    var sel_user = $('#sel_user :selected').text();
    if (sel_user == "所有人") {//群聊
      $('#messages').append($('<li>').text(cur_user + " : " + $('#cur_input').val()));
      socket.emit('chat message', $('#cur_input').val());
    } else {//私聊
      $('#messages').append($('<li>').text("(我 悄悄话 " + sel_user + ") : " + $('#cur_input').val()));
      socket.emit('private message', $('#sel_user').val(), $('#cur_input').val());
    }
    $('#cur_input').val('');
    return false;
  });

  /*
   链接状态
   接收当前在线用户数组，
   确定当前用户
   显示链接提示
   更新‘在线用户’
   */
  socket.on('connect status', function (msg, online) {
    online_list = online;
    cur_user = online_list['/#' + socket.id];
    $("#nickname").val(cur_user);
    $('#messages').append($('<li>').text(msg));
    updateOnlineUser(online);
  });

  socket.on('chat message', function (from, msg) {
    $('#messages li.msg').remove();
    $('#messages').append($('<li>').text(from + " : " + msg));
  });

  socket.on('typing', function (msg) {
    $('#messages li.msg').remove();
    if (msg != "") {
      $('#messages').append($('<li class="msg">').text(msg));
    }
  });

  socket.on('online refresh', function (online) {
    updateOnlineUser(online);
  });

  function modify_uid(uid) {
    var nickname = $("#nickname").val();
    if (nickname != cur_user) {
      socket.emit('modify uid', cur_user, nickname);
      cur_user = nickname;
    }

    $('#alert-box').modal('hide');
  }

  function updateOnlineUser(online) {
    $('.online').empty();
    var html = ['<p>在线用户</p>'];
    var options = ['<option value="">所有人</option>'];
    console.log(online, cur_user)
    for (key in online) {
      uname = online[key];
      if (key == '/#' + socket.id) {
        html.push('<div data-uid=' + uname +
            '> <a href="#" onclick="' +
            "$('#alert-box').modal('show')" +
            '">' + uname + '</a> 我 </div>');
//        $('.online_users').append(
//            $('<div data-uid=' + uname +
//                '> <a href="#" onclick="' +
//                "$('#alert-box').modal('show')" +
//                '">' + uname + '</a></div>'));
      } else {
        html.push('<div data-uid=' + uname + '>' + uname + '</div>');
//        $('.online_users').append($('<div data-uid=' + uname + '>' + uname + '</div>'));
        options.push('<option value="' + key + '">' + uname + '</option>')
      }
      $('.online_users').html(html.join(''));
      $('#sel_user').html(options.join(''));
    }
  }
</script>
</body>
</html>